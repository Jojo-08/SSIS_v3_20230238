<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Document{% endblock%}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />

    <script
      src="https://code.jquery.com/jquery-3.7.1.js"
      integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
      /* Toast notifications stay on top of everything */
      .toast-container {
        z-index: 9999 !important;
      }

      /* Confirmation modals should appear above form modals */
      #confirmModal,
      #deleteConfirmModal {
        z-index: 1060 !important;
      }
    </style>

    <script>
      // Handle stacked modals - adjust z-index when confirmation modals open
      document.addEventListener("DOMContentLoaded", function () {
        var confirmModals = ["confirmModal", "deleteConfirmModal"];
        confirmModals.forEach(function (modalId) {
          var modalEl = document.getElementById(modalId);
          if (modalEl) {
            modalEl.addEventListener("show.bs.modal", function () {
              // Find the highest z-index backdrop and set ours higher
              var backdrops = document.querySelectorAll(".modal-backdrop");
              if (backdrops.length > 0) {
                // Create a new backdrop with higher z-index after a tiny delay
                setTimeout(function () {
                  var newBackdrops =
                    document.querySelectorAll(".modal-backdrop");
                  if (newBackdrops.length > 1) {
                    newBackdrops[newBackdrops.length - 1].style.zIndex = "1055";
                  }
                }, 10);
              }
            });
          }
        });
      });
    </script>
  </head>

  <body>
    {% if current_user and current_user.is_authenticated %}
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">SSIS.<small>v2</small></a>
        <div class="d-flex">
          <!-- User Dropdown -->
          <div class="dropdown">
            <a
              class="btn btn-dark dropdown-toggle"
              href="#"
              role="button"
              id="userDropdown"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              {{current_user.username}}
            </a>

            <ul
              class="dropdown-menu dropdown-menu-end"
              aria-labelledby="userDropdown"
            >
              <li>
                <a class="dropdown-item" href="{{url_for('User.logout')}}"
                  >Logout</a
                >
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <nav class="navbar navbar-expand-lg navbar-dark bg-light">
      <ul class="nav nav-pills nav-fill w-100">
        <li class="nav-item">
          <a
            class="nav-link {%if request.path.startswith('/students')%}active{%endif%}"
            href="{{url_for('Student.list_students')}}"
            >Students</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link {%if request.path.startswith('/programs')%}active{%endif%}"
            href="{{url_for('Program.list_programs')}}"
            >Programs</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link {%if request.path.startswith('/colleges')%}active{%endif%}"
            href="{{url_for('College.list_colleges')}}"
            >Colleges</a
          >
        </li>
      </ul>
    </nav>

    {% endif %}
    <main class="container mt-4">
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div
        class="alert alert-{{ category }} alert-dismissible fade show"
        role="alert"
      >
        {{ message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      {% endfor %} {% endif %} {% endwith %} {% block content %} {% endblock %}
    </main>

    <!-- Toast Container - Appears on top of everything including modals -->
    <div
      class="toast-container position-fixed top-0 start-50 translate-middle-x p-3"
      style="z-index: 9999"
    >
      <div
        id="errorToast"
        class="toast align-items-center text-bg-danger border-0"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="d-flex">
          <div class="toast-body">
            <i class="bi bi-exclamation-circle me-2"></i>
            <span id="errorToastMessage">An error occurred</span>
          </div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
      </div>
      <div
        id="successToast"
        class="toast align-items-center text-bg-success border-0"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="d-flex">
          <div class="toast-body">
            <i class="bi bi-check-circle me-2"></i>
            <span id="successToastMessage">Operation successful</span>
          </div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div
      class="modal fade"
      id="deleteConfirmModal"
      tabindex="-1"
      aria-labelledby="deleteConfirmModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="deleteConfirmModalLabel">
              <i class="bi bi-trash me-2"></i>Confirm Delete
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p id="deleteMessage">
              Are you sure you want to delete this item? This action cannot be
              undone.
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <form id="deleteForm" method="POST" action="">
              <button type="submit" class="btn btn-danger">Yes, Delete</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal for Save Actions -->
    <div
      class="modal fade"
      id="confirmModal"
      tabindex="-1"
      aria-labelledby="confirmModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title" id="confirmModalLabel">
              <i class="bi bi-exclamation-triangle me-2"></i>Confirm Action
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p id="confirmMessage">
              Are you sure you want to save these changes?
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="confirmBtn">
              Yes, Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Toast notification functions
      function showErrorToast(message) {
        document.getElementById("errorToastMessage").textContent = message;
        var toast = new bootstrap.Toast(document.getElementById("errorToast"), {
          delay: 5000,
        });
        toast.show();
      }

      function showSuccessToast(message) {
        document.getElementById("successToastMessage").textContent = message;
        var toast = new bootstrap.Toast(
          document.getElementById("successToast"),
          { delay: 3000 }
        );
        toast.show();
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Reset form validation state when modal closes
        document.querySelectorAll(".modal").forEach(function (modalEl) {
          modalEl.addEventListener("hidden.bs.modal", function () {
            if (document.activeElement) {
              document.activeElement.blur();
            }
            var form = modalEl.querySelector("form");
            if (form) {
              form.classList.remove("was-validated");
              // Reset any server-side validation states
              form.querySelectorAll(".is-invalid").forEach(function (field) {
                field.classList.remove("is-invalid");
              });
              form.querySelectorAll(".is-valid").forEach(function (field) {
                field.classList.remove("is-valid");
              });
              // Reset invalid feedback display
              form
                .querySelectorAll(".invalid-feedback")
                .forEach(function (feedback) {
                  feedback.style.display = "";
                });

              // Reset form fields for "Add" modals only (not Edit modals)
              var modalTitle = modalEl.querySelector(".modal-title");
              if (
                modalTitle &&
                modalTitle.textContent.trim().startsWith("Add")
              ) {
                form.reset();
                // Also reset any image previews
                var preview = form.querySelector(".preview-image");
                if (preview) {
                  preview.src = "";
                  preview.classList.remove("show");
                }
              }
            }
          });
        });

        // Handle delete buttons with confirmation modal
        document.querySelectorAll(".delete-btn").forEach(function (btn) {
          btn.addEventListener("click", function (e) {
            e.preventDefault();
            var deleteUrl = this.getAttribute("data-delete-url");
            var itemName = this.getAttribute("data-item-name") || "this item";

            document.getElementById("deleteMessage").textContent =
              "Are you sure you want to delete " +
              itemName +
              "? This action cannot be undone.";
            document
              .getElementById("deleteForm")
              .setAttribute("action", deleteUrl);

            var deleteModal = new bootstrap.Modal(
              document.getElementById("deleteConfirmModal")
            );
            deleteModal.show();
          });
        });

        // Handle AJAX form submissions with Bootstrap validation
        document.querySelectorAll(".ajax-form").forEach(function (form) {
          form.addEventListener("submit", function (e) {
            e.preventDefault();

            // Bootstrap client-side validation first
            if (!form.checkValidity()) {
              e.stopPropagation();
              form.classList.add("was-validated");
              showErrorToast("Please fill in all required fields correctly.");
              return;
            }

            form.classList.add("was-validated");

            // Show confirmation dialog before saving
            var confirmModalEl = document.getElementById("confirmModal");
            var confirmModal = new bootstrap.Modal(confirmModalEl);
            document.getElementById("confirmMessage").textContent =
              "Are you sure you want to save these changes?";

            document.getElementById("confirmBtn").onclick = function () {
              confirmModal.hide();
              submitFormViaAjax(form);
            };

            confirmModal.show();
          });
        });
      });

      function submitFormViaAjax(form) {
        var submitBtn = form.querySelector('button[type="submit"]');
        var submitText = submitBtn.querySelector(".submit-text");
        var spinner = submitBtn.querySelector(".spinner-border");

        // Show loading state
        submitBtn.disabled = true;
        if (submitText) submitText.textContent = "Saving...";
        if (spinner) spinner.classList.remove("d-none");

        var formData = new FormData(form);

        fetch(form.action, {
          method: "POST",
          body: formData,
          headers: {
            "X-Requested-With": "XMLHttpRequest",
          },
        })
          .then(function (response) {
            return response.json().then(function (data) {
              return { ok: response.ok, data: data };
            });
          })
          .then(function (result) {
            if (result.ok && result.data.success) {
              // Success - close modal and reload
              var modalId = form.getAttribute("data-modal-id");
              var modalEl = document.getElementById(modalId);
              if (modalEl) {
                var modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
              }
              showSuccessToast(result.data.message || "Operation successful!");
              setTimeout(function () {
                window.location.reload();
              }, 1000);
            } else {
              // Error - show toast on top of modal
              var errorMsg = result.data.error || "An error occurred";

              // Remove was-validated to prevent green checkmarks on fields
              form.classList.remove("was-validated");

              // If there are field-specific errors, format them
              if (result.data.errors) {
                var fieldErrors = [];
                for (var field in result.data.errors) {
                  fieldErrors.push(
                    field + ": " + result.data.errors[field].join(", ")
                  );

                  // Mark the specific field as invalid
                  var fieldInput = form.querySelector('[name="' + field + '"]');
                  if (fieldInput) {
                    fieldInput.classList.add("is-invalid");
                    fieldInput.classList.remove("is-valid");

                    // Add or update the invalid feedback
                    var parent = fieldInput.closest(".mb-3");
                    var feedback = parent
                      ? parent.querySelector(".invalid-feedback")
                      : null;
                    if (feedback) {
                      feedback.textContent =
                        result.data.errors[field].join(", ");
                      feedback.style.display = "block";
                    }
                  }
                }
                if (fieldErrors.length > 0) {
                  errorMsg = fieldErrors.join("; ");
                }
              }

              // If error mentions "already exist" or "duplicate", mark the code field as invalid
              if (
                errorMsg.toLowerCase().includes("already exist") ||
                errorMsg.toLowerCase().includes("duplicate") ||
                errorMsg.toLowerCase().includes("may already")
              ) {
                var firstCodeField = form.querySelector(
                  'input[name$="_code"]:not([readonly])'
                );
                if (firstCodeField) {
                  firstCodeField.classList.add("is-invalid");
                  firstCodeField.classList.remove("is-valid");

                  // Find or create the invalid feedback message
                  var parent = firstCodeField.closest(".mb-3");
                  var feedback = parent
                    ? parent.querySelector(".invalid-feedback")
                    : null;

                  if (feedback) {
                    feedback.textContent = "This code already exists.";
                    feedback.style.display = "block";
                  } else {
                    // Create feedback element if it doesn't exist
                    var newFeedback = document.createElement("div");
                    newFeedback.className = "invalid-feedback";
                    newFeedback.textContent = "This code already exists.";
                    newFeedback.style.display = "block";
                    firstCodeField.parentNode.appendChild(newFeedback);
                  }
                }
              }

              showErrorToast(errorMsg);

              // Reset button state
              submitBtn.disabled = false;
              if (submitText) submitText.textContent = "Save";
              if (spinner) spinner.classList.add("d-none");
            }
          })
          .catch(function (error) {
            showErrorToast("Network error. Please try again.");
            submitBtn.disabled = false;
            if (submitText) submitText.textContent = "Save";
            if (spinner) spinner.classList.add("d-none");
          });
      }
    </script>

    {% if open_modal %}
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var modal = document.getElementById("{{ open_modal }}");
        if (modal) {
          var modalInstance = new bootstrap.Modal(modal);
          modalInstance.show();
        }
      });
    </script>
    {% endif %}
  </body>
</html>
