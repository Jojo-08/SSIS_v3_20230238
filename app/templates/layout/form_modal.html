<style>
  .upload-dropzone {
    border: 2px dashed #dee2e6;
    border-radius: 0.375rem;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    position: relative;
    background-color: #f8f9fa;
    transition: all 0.2s ease;
  }
  .upload-dropzone:hover {
    border-color: #0d6efd;
    background-color: #e9ecef;
  }
  .upload-dropzone.invalid {
    border-color: #dc3545;
    background-color: #f8d7da;
  }
  .upload-dropzone.valid {
    border-color: #198754;
    background-color: #d1e7dd;
  }
  .upload-dropzone.invalid {
    border-color: #dc3545;
    background-color: #f8d7da;
  }
  .upload-dropzone.valid {
    border-color: #198754;
    background-color: #d1e7dd;
  }
  .upload-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
    z-index: 10;
  }
  .preview-image {
    max-width: 100%;
    max-height: 150px;
    margin-top: 1rem;
    border-radius: 0.25rem;
    display: none;
    object-fit: contain;
  }
  .preview-image.show {
    display: block;
    margin-left: auto;
    margin-right: auto;
  }
  /* Bootstrap validation styling */
  .was-validated .form-control:invalid,
  .was-validated .form-select:invalid {
    border-color: #dc3545;
  }
  .was-validated .form-control:valid,
  .was-validated .form-select:valid {
    border-color: #198754;
  }
</style>

<div
  class="modal fade"
  id="{{ modal_id }}"
  tabindex="-1"
  aria-labelledby="{{ modal_id }}Label"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form
        method="POST"
        action="{{ action_url }}"
        enctype="multipart/form-data"
        class="ajax-form needs-validation"
        data-modal-id="{{ modal_id }}"
        novalidate
      >
        {{ form.hidden_tag() }}
        <div class="modal-header">
          <h5 class="modal-title" id="{{ modal_id }}Label">
            {{ modal_title or ('Add ' + entity_name) }}
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>

        <div class="modal-body">
          {% for field in form %} {% if field.type not in ['CSRFTokenField',
          'SubmitField'] %} {% if field.name == 'photo' %}
          <div class="mb-3">
            {{ field.label(class="form-label") }}
            <div class="upload-dropzone">
              {{ field(class="upload-input", onchange="previewImage(this,
              'preview-" ~ modal_id ~ "')") }}
              <div class="upload-content">
                <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                <p class="mb-0 text-muted">Drag & Drop or Click to Upload</p>

                <img
                  id="preview-{{ modal_id }}"
                  src="{{ current_photo_url if current_photo_url else '' }}"
                  class="preview-image {{ 'show' if current_photo_url else '' }}"
                  alt="Photo Preview"
                />
              </div>
            </div>
            {% for error in field.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
          {% elif field.name == 'student_id' %}
          <div class="mb-3">
            {{ field.label(class="form-label") }} {% if 'Edit' in modal_title %}
            {{ field(class="form-control", readonly=true,
            style="background-color: #e9ecef;") }}
            <small class="text-muted">Student ID cannot be changed</small>
            {% else %} {{ field(class="form-control", required=true,
            pattern="^\\d{4}-\\d{4}$", placeholder="YYYY-NNNN") }}
            <div class="invalid-feedback">
              Please enter a valid Student ID (format: YYYY-NNNN)
            </div>
            {% endif %}
          </div>
          {% elif field.type == 'SelectField' %}
          <div class="mb-3">
            {{ field.label(class="form-label") }} {{ field(class="form-select",
            required=true) }}
            <div class="invalid-feedback">Please select an option.</div>
          </div>
          {% else %}
          <div class="mb-3">
            {{ field.label(class="form-label") }} {{ field(class="form-control",
            required=true) }}
            <div class="invalid-feedback">This field is required.</div>
          </div>
          {% endif %} {% endif %} {% endfor %}
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            <span class="submit-text"
              >{{ form.submit.label.text if form.submit else 'Save' }}</span
            >
            <span
              class="spinner-border spinner-border-sm d-none"
              role="status"
              aria-hidden="true"
            ></span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function previewImage(input, previewId) {
    const preview = document.getElementById(previewId);
    const file = input.files && input.files[0];

    // Get the upload dropzone and feedback elements
    const dropzone = input.closest(".upload-dropzone");
    const parentDiv = dropzone.closest(".mb-3");
    let feedbackDiv = parentDiv.querySelector(".invalid-feedback");

    // Create feedback div if it doesn't exist
    if (!feedbackDiv) {
      feedbackDiv = document.createElement("div");
      feedbackDiv.className = "invalid-feedback";
      feedbackDiv.style.display = "block";
      parentDiv.appendChild(feedbackDiv);
    }

    // Clear previous validation states
    input.classList.remove("is-invalid", "is-valid");
    dropzone.classList.remove("invalid", "valid");
    feedbackDiv.textContent = "";
    feedbackDiv.style.display = "none";

    if (!file) {
      preview.classList.remove("show");
      preview.src = "";
      return;
    }

    // Validate file type by both MIME type and extension
    const allowedTypes = ["image/jpeg", "image/jpg", "image/png"];
    const allowedExtensions = [".jpg", ".jpeg", ".png"];
    const fileExtension = file.name
      .toLowerCase()
      .substring(file.name.lastIndexOf("."));

    if (
      !allowedTypes.includes(file.type) ||
      !allowedExtensions.includes(fileExtension)
    ) {
      input.classList.add("is-invalid");
      dropzone.classList.add("invalid");
      feedbackDiv.textContent = "Only JPG, JPEG, and PNG images are allowed.";
      feedbackDiv.style.display = "block";
      input.value = ""; // Clear the input
      preview.classList.remove("show");
      preview.src = "";
      return;
    }

    // Validate file size (5MB = 5 * 1024 * 1024 bytes)
    const maxSize = 5 * 1024 * 1024;
    if (file.size > maxSize) {
      input.classList.add("is-invalid");
      dropzone.classList.add("invalid");
      const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
      feedbackDiv.textContent = `File size (${sizeMB}MB) exceeds 5MB limit.`;
      feedbackDiv.style.display = "block";
      input.value = ""; // Clear the input
      preview.classList.remove("show");
      preview.src = "";
      return;
    }

    // File is valid - show green border and preview
    input.classList.add("is-valid");
    dropzone.classList.add("valid");

    const reader = new FileReader();
    reader.onload = function (e) {
      preview.src = e.target.result;
      preview.classList.add("show");
    };
    reader.readAsDataURL(file);
  }

  // Reset form and file input when modal is hidden
  document.addEventListener("DOMContentLoaded", function () {
    const modals = document.querySelectorAll(".modal");
    modals.forEach(function (modal) {
      modal.addEventListener("hidden.bs.modal", function () {
        const form = modal.querySelector("form");
        if (form) {
          // Clear file input FIRST (before form.reset())
          const fileInput = form.querySelector('input[type="file"]');
          const isEditModal = modal.id.includes("editStudentModal");
          const originalPhotoSrc = fileInput
            ? document
                .getElementById(
                  fileInput.getAttribute("onchange").match(/preview-[^']+/)[0]
                )
                ?.getAttribute("data-original-src")
            : null;

          if (fileInput) {
            // Clone and replace the file input to truly clear it
            const newFileInput = fileInput.cloneNode(true);
            fileInput.parentNode.replaceChild(newFileInput, fileInput);

            const previewId = newFileInput
              .getAttribute("onchange")
              .match(/preview-[^']+/)[0];
            const preview = document.getElementById(previewId);

            if (preview) {
              // For edit modals, restore original photo; for add modals, clear it
              if (isEditModal && originalPhotoSrc) {
                preview.src = originalPhotoSrc;
                preview.classList.add("show");
              } else {
                preview.classList.remove("show");
                preview.src = "";
              }
            }

            // Clear validation states
            newFileInput.classList.remove("is-valid", "is-invalid");
            const dropzone = newFileInput.closest(".upload-dropzone");
            if (dropzone) {
              dropzone.classList.remove("invalid", "valid");
            }
            const feedback = newFileInput
              .closest(".mb-3")
              ?.querySelector(".invalid-feedback");
            if (feedback) {
              feedback.style.display = "none";
            }
          }

          // Reset the rest of the form
          form.reset();

          // Remove all validation classes
          form.classList.remove("was-validated");
          form
            .querySelectorAll(".is-valid, .is-invalid")
            .forEach(function (el) {
              el.classList.remove("is-valid", "is-invalid");
            });

          // Hide all feedback messages
          form.querySelectorAll(".invalid-feedback").forEach(function (fb) {
            fb.style.display = "none";
          });
        }
      });
    });

    // Store original photo URLs for edit modals
    modals.forEach(function (modal) {
      modal.addEventListener("show.bs.modal", function () {
        const form = modal.querySelector("form");
        if (form) {
          const fileInput = form.querySelector('input[type="file"]');
          if (fileInput) {
            const previewId = fileInput
              .getAttribute("onchange")
              .match(/preview-[^']+/)[0];
            const preview = document.getElementById(previewId);
            if (preview && preview.src && preview.classList.contains("show")) {
              // Store the original src as a data attribute
              preview.setAttribute("data-original-src", preview.src);
            }
          }
        }
      });
    });
  });
</script>
